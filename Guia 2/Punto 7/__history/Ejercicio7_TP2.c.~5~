#include <Ejercicio7_TP2.h>

#fuses INTRC_IO   // Oscilador interno con pines RA6 y RA7 como GPIO
#fuses NOMCLR     // Desactivo el MCLR
#fuses NOWDT      // Desactivo el watchdog     
#use delay(clock=4000000) 

typedef unsigned int8 t_dac_value; 

// Prototipos
void Init_GPIO(void);
void Init_ADC(void);
void Init_DAC(void);

// Variables globales
unsigned int16 resultado_adc = 0;
t_dac_value resultado_dac = 0; 

/*****************************************************************************
* Interrupciones (ISR)
****************************************************************************/
#INT_AD
void ISR_ADC(void) {
    // 1. Leo conversión (10 bits)
    resultado_adc = read_adc(ADC_READ_ONLY); 
    
    // 2. Escalado de 10 bits a 5 bits (1024 niveles -> 32 niveles)
    resultado_dac = (t_dac_value)(resultado_adc >> 5); 

    // 3. ENVIAR VALOR AL MÓDULO DAC INTERNO
    dac_write(resultado_dac); 
    
    // 4. Iniciar la siguiente conversión inmediatamente (muestreo periódico)
    read_adc(ADC_START_ONLY); 
}


void main()
{
    Init_GPIO();
    Init_ADC();
    Init_DAC();

    // *** CORRECCIÓN CRÍTICA: PULSO INICIAL DEL ADC ***
    read_adc(ADC_START_ONLY); 

    // El bucle principal solo espera el flujo de interrupciones
    while(TRUE)
    {
        // El proceso está autocontenido en la ISR.
        // Se puede usar SLEEP para ahorro de energía aquí.
    }
}

void Init_GPIO()
{
    // *** CORRECCIÓN CRÍTICA: Desactivar funciones analógicas para DAC ***
    // RA0 (AN0) es analógico, el resto es digital/output.
    setup_adc_ports(sAN0 | VSS_VREF); // Asegura que AN0 es analógico y el resto digital (VREF es VDD/VSS)
    
    // set_tris_a: RA0 (AN0) es entrada (1), RA2 (DACOUT) es salida (0).
    set_tris_a(0b00000001); 
    
    // set_tris_b: Todos como entrada (1), ya que no se usan.
    set_tris_b(0b11111111); 

    enable_interrupts(GLOBAL);
}

void Init_ADC() {
    setup_adc(ADC_CLOCK_INTERNAL); 
    set_adc_channel(0); // Selecciona AN0
    enable_interrupts(INT_AD); 
}

void Init_DAC(void) {
    setup_dac(DAC_VSS_VDD | DAC_OUTPUT); 
}
