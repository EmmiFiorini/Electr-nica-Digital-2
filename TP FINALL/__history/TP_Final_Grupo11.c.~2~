#include <TP_Final_Grupo11.h>

#fuses INTRC_IO   // Oscilador interno con pines RA6 y RA7 como GPIO
#fuses NOMCLR     // Desactivo el MCLR
#fuses NOWDT      // Desactivo el watchdog

/*****************************************************************************
 * Funciones de Inicializacion
 ****************************************************************************/
 
void Init_GPIO(void);
void Init_Keypad(void);

/*****************************************************************************
* Variables globales
****************************************************************************/

const char keymap[4][3] = {
  {'1','2','3'},
  {'4','5','6'},
  {'7','8','9'},
  {'*','0','#'}
};

/*****************************************************************************
* Funciones
****************************************************************************/

void maquina(void);
char getKey(void);

/*****************************************************************************
* Interrupciones
****************************************************************************/

void main()
{

   Init_GPIO();
   Init_Keypad();
   
   while(TRUE)
   {


    
   }

}

void maquina(void) {
}

void Init_GPIO(void){ 
   
   set_tris_a(0b00000111); // RA0-RA2 columnas del teclado, son entradas
   set_tris_b(0b00011110); // RB0, RB5, RB6 y RB7 filas del teclado, son salidas
   
   enable_interrupts(GLOBAL);
}

void Init_Keypad(void){
   
   setup_adc_ports(NO_ANALOGS); // desactiva funciones analógicas en los pines si aplica

   // Se dejan las filas inicialmente en HIGH (no activas)
   output_high(PIN_B0);
   output_high(PIN_B5);
   output_high(PIN_B6);
   output_high(PIN_B7);
}

char getKey(void){
   
   const unsigned char pines_filas[4] = {PIN_B0, PIN_B5, PIN_B6, PIN_B7};
   const unsigned char pines_col[3] = {PIN_A0, PIN_A1, PIN_A2};
   int f, c;
   char result = 0;
   
   // Seteamos en high las filas de nuevo
   output_high(PIN_B0);
   output_high(PIN_B5);
   output_high(PIN_B6);
   output_high(PIN_B7);
   
   for(f = 0; f < 4; f++) {
      // Poner todas las filas en HIGH
      output_high(PIN_B0);
      output_high(PIN_B5);
      output_high(PIN_B6);
      output_high(PIN_B7);

      // Activar la fila r (tirarla a LOW)
      output_low(pines_filas[f]);

      // Leemos columnas
      for(c = 0; c < 3; c++) {
         if(!input(pines_col[c])) { // columna detectada en 0 --> tecla presionada
           
            // Debounce simple
            delay_ms(20);
            
            if(!input(pines_col[c])) { // sigue presionada
               result = keymap[f][c];

               /* Esperar a que suelte la tecla para evitar múltiples lecturas
               while(!input(col_pins[c])) {
                  delay_ms(5);
               }
               */
               
               // Restaurar fila y retornar result
               output_high(pines_filas[f]);
               return result;
            }
         }
      }

      // Restaurar fila antes de pasar a la siguiente
      output_high(pines_filas[f]);
   }

   return 0; // No se presiono ninguna tecla
}

